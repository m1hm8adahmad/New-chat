<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TapText - Social Media Platform</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter&display=swap');
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    padding: 0;
    font-family: 'Inter', sans-serif;
    background: #f0f2f5;
    color: #050505;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    background-color: var(--bg-color);
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  :root {
    --primary-color: #1877f2;
    --primary-hover: #165ec9;
    --bg-color: #f0f2f5;
    --text-color: #050505;
    --input-bg: #fff;
    --input-border: #ccd0d5;
    --box-shadow: rgba(0,0,0,0.1);
    --warn-color: #b22222;
  }
  .dark-theme {
    --primary-color: #4a90e2;
    --primary-hover: #3571c4;
    --bg-color: #18191a;
    --text-color: #e4e6eb;
    --input-bg: #242526;
    --input-border: #3a3b3c;
    --box-shadow: rgba(255,255,255,0.1);
    --warn-color: #e06666;
  }
  header {
    background-color: var(--primary-color);
    color: white;
    font-weight: 700;
    font-size: 1.8rem;
    padding: 1rem 2rem;
    box-shadow: 0 2px 6px var(--box-shadow);
    display: flex;
    align-items: center;
    justify-content: space-between;
    user-select: none;
  }
  header h1 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  header h1 .verified {
    color: #4caf50;
    font-weight: 900;
    font-size: 1.3rem;
  }
  #themeToggle {
    cursor: pointer;
    background: transparent;
    border: none;
    color: white;
    font-size: 1.3rem;
    user-select: none;
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    transition: background-color 0.3s ease;
  }
  #themeToggle:hover {
    background-color: rgba(255,255,255,0.2);
  }
  main {
    flex: 1;
    display: flex;
    max-width: 1100px;
    margin: 1rem auto 2rem;
    gap: 1rem;
    padding: 0 1rem;
  }
  /* Sidebar */
  #sidebar {
    flex: 0 0 250px;
    background-color: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 2px 8px var(--box-shadow);
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
  }
  #sidebar h2 {
    margin: 0 0 0.6rem 0;
    font-weight: 700;
    color: var(--primary-color);
  }
  #userInfo {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
    font-weight: 600;
  }
  #userInfo span {
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }
  #userInfo .verifiedTick {
    color: #4caf50;
    font-weight: 900;
    font-size: 1.1rem;
  }
  #userActions button {
    margin-top: 1rem;
    padding: 0.5rem 1rem;
    font-weight: 600;
    background-color: var(--primary-color);
    border: none;
    color: white;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    width: 100%;
  }
  #userActions button:hover {
    background-color: var(--primary-hover);
  }
  #followSection {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }
  #followSection input {
    width: 100%;
    padding: 0.4rem 0.7rem;
    font-size: 1rem;
    border-radius: 8px;
    border: 1.5px solid var(--input-border);
    background-color: var(--input-bg);
    color: var(--text-color);
    transition: border-color 0.3s ease;
  }
  #followSection input:focus {
    outline: none;
    border-color: var(--primary-color);
  }
  #followSection button {
    background-color: var(--primary-color);
    border: none;
    color: white;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s ease;
  }
  #followSection button:hover {
    background-color: var(--primary-hover);
  }
  #followingList {
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid var(--input-border);
    border-radius: 8px;
    padding: 0.5rem;
    background-color: var(--input-bg);
  }
  #followingList div {
    padding: 0.25rem 0.3rem;
    border-bottom: 1px solid var(--input-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #followingList div:last-child {
    border-bottom: none;
  }
  #followingList button {
    background: transparent;
    border: none;
    color: var(--primary-color);
    cursor: pointer;
    font-weight: 700;
    transition: color 0.3s ease;
  }
  #followingList button:hover {
    color: var(--primary-hover);
  }

  /* Content Area */
  #contentArea {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* Registration/Login forms */
  #authSection {
    background-color: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 12px;
    padding: 2rem 2.5rem;
    box-shadow: 0 2px 12px var(--box-shadow);
    max-width: 480px;
    margin: 1rem auto;
  }
  #authSection h2 {
    margin-top: 0;
    color: var(--primary-color);
    font-weight: 700;
  }
  #authSection label {
    display: block;
    margin-top: 1rem;
    font-weight: 600;
  }
  #authSection input, #authSection select {
    width: 100%;
    padding: 0.5rem 0.7rem;
    margin-top: 0.3rem;
    border-radius: 8px;
    border: 1.5px solid var(--input-border);
    font-size: 1rem;
    background-color: var(--input-bg);
    color: var(--text-color);
    transition: border-color 0.3s ease;
  }
  #authSection input:focus, #authSection select:focus {
    outline: none;
    border-color: var(--primary-color);
  }
  #authSection button {
    margin-top: 1.5rem;
    background-color: var(--primary-color);
    border: none;
    color: white;
    padding: 0.7rem 1rem;
    font-weight: 700;
    font-size: 1.1rem;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    width: 100%;
  }
  #authSection button:hover:not(:disabled) {
    background-color: var(--primary-hover);
  }
  #authSection button:disabled {
    background-color: #a0a0a0;
    cursor: default;
  }
  #authError {
    color: var(--warn-color);
    font-weight: 700;
    margin-top: 0.7rem;
    user-select: none;
  }

  /* Posts Feed */
  #postFeed {
    background-color: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    box-shadow: 0 2px 12px var(--box-shadow);
    max-height: 600px;
    overflow-y: auto;
  }
  #postFeed h3 {
    margin-top: 0;
    color: var(--primary-color);
    font-weight: 700;
  }
  .post {
    border-bottom: 1px solid var(--input-border);
    padding: 1rem 0;
    user-select: none;
  }
  .post:last-child {
    border-bottom: none;
  }
  .post .post-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .post .post-username {
    font-weight: 700;
    color: var(--primary-color);
  }
  .post .verifiedTickSmall {
    color: #4caf50;
    font-weight: 900;
    font-size: 1rem;
  }
  .post .post-role {
    font-style: italic;
    font-size: 0.85rem;
    color: #666;
  }
  .post .post-time {
    margin-left: auto;
    font-size: 0.8rem;
    color: #999;
  }
  .post .post-content {
    margin-top: 0.4rem;
    white-space: pre-wrap;
    font-size: 1rem;
    color: var(--text-color);
  }
  .post img,
  .post video {
    max-width: 100%;
    margin-top: 0.7rem;
    border-radius: 12px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  }
  .post video {
    max-height: 320px;
  }
  /* Admin controls on posts */
  .post .admin-controls {
    margin-top: 0.4rem;
    display: flex;
    gap: 0.5rem;
  }
  .post .admin-controls button {
    font-size: 0.8rem;
    padding: 0.3rem 0.7rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    background-color: var(--primary-color);
    color: white;
    transition: background-color 0.3s ease;
  }
  .post .admin-controls button:hover {
    background-color: var(--primary-hover);
  }

  /* New post section */
  #newPostSection {
    background-color: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    box-shadow: 0 2px 12px var(--box-shadow);
    margin-top: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }
  #newPostSection textarea {
    resize: vertical;
    min-height: 100px;
    font-size: 1rem;
    padding: 0.7rem;
    border-radius: 10px;
    border: 1.5px solid var(--input-border);
    background-color: var(--input-bg);
    color: var(--text-color);
    transition: border-color 0.3s ease;
  }
  #newPostSection textarea:focus {
    outline: none;
    border-color: var(--primary-color);
  }
  #newPostSection input[type="url"] {
    padding: 0.5rem;
    border-radius: 10px;
    border: 1.5px solid var(--input-border);
    font-size: 1rem;
    background-color: var(--input-bg);
    color: var(--text-color);
    transition: border-color 0.3s ease;
  }
  #newPostSection input[type="url"]:focus {
    outline: none;
    border-color: var(--primary-color);
  }
  #newPostSection select {
    width: 150px;
  }
  #newPostSection button {
    align-self: flex-start;
    background-color: var(--primary-color);
    border: none;
    color: white;
    font-weight: 700;
    padding: 0.6rem 1.4rem;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #newPostSection button:hover:not(:disabled) {
    background-color: var(--primary-hover);
  }
  #newPostSection button:disabled {
    background-color: #a0a0a0;
    cursor: default;
  }
  #postError {
    color: var(--warn-color);
    font-weight: 700;
    user-select: none;
  }

  /* DM Center */
  #dmCenter {
    flex: 1;
    display: flex;
    flex-direction: column;
    background-color: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 12px;
    box-shadow: 0 2px 12px var(--box-shadow);
    overflow: hidden;
  }
  #dmHeader {
    background-color: var(--primary-color);
    color: white;
    padding: 1rem;
    font-weight: 700;
    font-size: 1.2rem;
    user-select: none;
  }
  #dmMain {
    display: flex;
    flex: 1;
    height: 100%;
  }
  #dmUsersList {
    width: 220px;
    border-right: 1px solid var(--input-border);
    overflow-y: auto;
    background-color: var(--input-bg);
  }
  #dmUsersList div {
    padding: 0.7rem 1rem;
    border-bottom: 1px solid var(--input-border);
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }
  #dmUsersList div:hover, #dmUsersList .active {
    background-color: var(--primary-color);
    color: white;
  }
  #dmUsersList .verifiedTickSmall {
    color: #4caf50;
    font-weight: 900;
    font-size: 1rem;
  }
  #dmChatArea {
    flex: 1;
    display: flex;
    flex-direction: column;
    background-color: var(--input-bg);
  }
  #dmMessages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.7rem;
  }
  .dm-message {
    max-width: 65%;
    padding: 0.6rem 1rem;
    border-radius: 20px;
    font-size: 1rem;
    line-height: 1.3;
    word-wrap: break-word;
  }
  .dm-message.sent {
    align-self: flex-end;
    background-color: var(--primary-color);
    color: white;
    border-bottom-right-radius: 2px;
  }
  .dm-message.received {
    align-self: flex-start;
    background-color: #e4e6eb;
    color: #050505;
    border-bottom-left-radius: 2px;
  }
  #dmInputArea {
    padding: 0.8rem;
    border-top: 1px solid var(--input-border);
    display: flex;
    gap: 0.7rem;
  }
  #dmInput {
    flex: 1;
    padding: 0.6rem 0.8rem;
    font-size: 1rem;
    border-radius: 20px;
    border: 1.5px solid var(--input-border);
    background-color: var(--input-bg);
    color: var(--text-color);
    transition: border-color 0.3s ease;
  }
  #dmInput:focus {
    outline: none;
    border-color: var(--primary-color);
  }
  #dmSendBtn {
    background-color: var(--primary-color);
    border: none;
    color: white;
    padding: 0 1.2rem;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 700;
    transition: background-color 0.3s ease;
  }
  #dmSendBtn:hover:not(:disabled) {
    background-color: var(--primary-hover);
  }
  #dmSendBtn:disabled {
    background-color: #a0a0a0;
    cursor: default;
  }

  /* Responsive */
  @media (max-width: 900px) {
    main {
      flex-direction: column;
      max-width: 100%;
      margin: 0.5rem;
      gap: 1rem;
    }
    #sidebar {
      width: 100%;
      flex: none;
      order: 2;
    }
    #contentArea {
      order: 3;
    }
    #dmCenter {
      order: 1;
      height: 400px;
    }
    #dmUsersList {
      width: 100px;
    }
  }
</style>
</head>
<body>

<header>
  <h1>
    TapText
    <span class="verified" title="Verified Owner">‚úîÔ∏è</span>
  </h1>
  <button id="themeToggle" aria-label="Toggle Light/Dark Theme">üåô</button>
</header>

<main>
  <section id="sidebar" aria-label="User sidebar and actions">
    <h2>User Info</h2>
    <div id="userInfo">
      <span><strong id="currentUsername">Not logged in</strong> <span id="verifiedTick" class="verifiedTick" style="display:none;">‚úîÔ∏è</span></span>
      <span id="currentRole">Role: Guest</span>
      <span id="currentAge"></span>
      <span id="parentOf" style="display:none;">Parent of: <span id="childrenList"></span></span>
    </div>
    <div id="userActions">
      <button id="btnLogout" style="display:none;">Logout</button>
    </div>
    <div id="followSection" style="display:none;">
      <h2>Follow Users</h2>
      <input type="text" id="searchUserInput" placeholder="Search users..." aria-label="Search users" autocomplete="off"/>
      <button id="btnFollow">Follow</button>
      <div id="followingList" aria-live="polite" aria-label="List of users you follow"></div>
    </div>
  </section>

  <section id="contentArea" aria-label="Main content area">
    <div id="authSection" aria-live="polite" aria-atomic="true">
      <h2>Register or Login</h2>
      <form id="authForm" novalidate>
        <label for="usernameInput">Username</label>
        <input type="text" id="usernameInput" name="username" minlength="3" maxlength="20" autocomplete="username" required pattern="^[a-zA-Z0-9_]+$" aria-describedby="usernameHelp" />
        <small id="usernameHelp">3-20 chars, letters, numbers, underscores only</small>

        <label for="passwordInput">Password</label>
        <input type="password" id="passwordInput" name="password" minlength="6" autocomplete="new-password" required />

        <label for="confirmPasswordInput">Confirm Password</label>
        <input type="password" id="confirmPasswordInput" name="confirmPassword" minlength="6" autocomplete="new-password" required />

        <label for="birthdateInput">Birthdate</label>
        <input type="date" id="birthdateInput" name="birthdate" required max="" aria-describedby="ageHelp" />
        <small id="ageHelp">You must be at least 10 years old.</small>

        <label for="isParentCheckbox" style="display:flex; align-items:center; gap:0.5rem;">
          <input type="checkbox" id="isParentCheckbox" name="isParent" />
          Create a Parent Account (to manage child accounts)
        </label>

        <button type="submit" id="btnAuthSubmit">Register / Login</button>
        <div id="authError" role="alert" aria-live="assertive"></div>
      </form>
    </div>

    <div id="newPostSection" style="display:none;" aria-label="Create new post">
      <textarea id="newPostContent" maxlength="1000" placeholder="What's on your mind?" aria-label="Post content"></textarea>
      <input type="url" id="newPostMediaUrl" placeholder="Optional: Add image or video URL" aria-label="Media URL" />
      <label for="postAgeRestriction">Restrict post visibility to age group:</label>
      <select id="postAgeRestriction" aria-label="Post age restriction">
        <option value="all">All ages</option>
        <option value="10-12">10 - 12</option>
        <option value="13-17">13 - 17</option>
        <option value="18+">18+</option>
      </select>
      <button id="btnPost" disabled>Post</button>
      <div id="postError" role="alert" aria-live="assertive"></div>
    </div>

    <div id="postFeed" aria-live="polite" aria-label="Posts feed" tabindex="0">
      <h3>Posts</h3>
      <div id="postsContainer" aria-live="polite"></div>
    </div>
  </section>

  <section id="dmCenter" aria-label="Direct messages" style="display:none;">
    <div id="dmHeader">Direct Messages</div>
    <div id="dmMain">
      <div id="dmUsersList" role="list" tabindex="0" aria-label="List of direct message users"></div>
      <div id="dmChatArea">
        <div id="dmMessages" aria-live="polite" aria-relevant="additions"></div>
        <div id="dmInputArea">
          <input type="text" id="dmInput" placeholder="Type a message..." aria-label="Message input" autocomplete="off" />
          <button id="dmSendBtn" disabled>Send</button>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
(() => {
  // Config for JSONBin
  const BIN_ID = "6863fa078561e97a502fb26c";
  const WRITE_KEY = "$2a$10$4EX1ZT6TPAE1x4NBUFgmt.Qvwek6Ognuqf1kNZ.Y8IjLfKf2i0GUG";
  const READ_KEY = WRITE_KEY;

  // Constants
  const MIN_AGE = 10;

  // State
  let users = {}; // { username: {username, passwordHash, birthdate, role, isParent, children:[], followers:[], following:[], warnings:[], banned: false} }
  let posts = []; // {id, author, content, mediaUrl, timestamp, ageRestriction}
  let dms = {};   // {user1_user2: [{sender, message, timestamp}] }
  let currentUser = null; // {username,...}

  // Cache DOM
  const themeToggleBtn = document.getElementById('themeToggle');
  const currentUsernameSpan = document.getElementById('currentUsername');
  const currentRoleSpan = document.getElementById('currentRole');
  const verifiedTickSpan = document.getElementById('verifiedTick');
  const parentOfSpan = document.getElementById('parentOf');
  const childrenListSpan = document.getElementById('childrenList');
  const currentAgeSpan = document.getElementById('currentAge');

  const btnLogout = document.getElementById('btnLogout');
  const followSection = document.getElementById('followSection');
  const searchUserInput = document.getElementById('searchUserInput');
  const btnFollow = document.getElementById('btnFollow');
  const followingList = document.getElementById('followingList');

  const authSection = document.getElementById('authSection');
  const authForm = document.getElementById('authForm');
  const usernameInput = document.getElementById('usernameInput');
  const passwordInput = document.getElementById('passwordInput');
  const confirmPasswordInput = document.getElementById('confirmPasswordInput');
  const birthdateInput = document.getElementById('birthdateInput');
  const isParentCheckbox = document.getElementById('isParentCheckbox');
  const btnAuthSubmit = document.getElementById('btnAuthSubmit');
  const authErrorDiv = document.getElementById('authError');

  const newPostSection = document.getElementById('newPostSection');
  const newPostContent = document.getElementById('newPostContent');
  const newPostMediaUrl = document.getElementById('newPostMediaUrl');
  const postAgeRestriction = document.getElementById('postAgeRestriction');
  const btnPost = document.getElementById('btnPost');
  const postErrorDiv = document.getElementById('postError');
  const postsContainer = document.getElementById('postsContainer');

  const dmCenter = document.getElementById('dmCenter');
  const dmUsersList = document.getElementById('dmUsersList');
  const dmMessages = document.getElementById('dmMessages');
  const dmInput = document.getElementById('dmInput');
  const dmSendBtn = document.getElementById('dmSendBtn');

  // Utility Functions

  // Hash password (simple, NOT secure for prod, demo only)
  function hashPassword(password) {
    let hash = 0, i, chr;
    if (password.length === 0) return hash.toString();
    for (i = 0; i < password.length; i++) {
      chr   = password.charCodeAt(i);
      hash  = ((hash << 5) - hash) + chr;
      hash |= 0;
    }
    return hash.toString();
  }

  // Validate birthdate minimum age
  function isOldEnough(birthdate) {
    if (!birthdate) return false;
    const bd = new Date(birthdate);
    if (isNaN(bd.getTime())) return false;
    const now = new Date();
    const ageDiff = now.getFullYear() - bd.getFullYear();
    if (ageDiff > MIN_AGE) return true;
    if (ageDiff < MIN_AGE) return false;
    // same year, check month/day
    if (now.getMonth() > bd.getMonth()) return true;
    if (now.getMonth() < bd.getMonth()) return false;
    return now.getDate() >= bd.getDate();
  }

  // Format date to relative time
  function timeAgo(date) {
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    if (seconds < 60) return `${seconds}s ago`;
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days}d ago`;
    return date.toLocaleDateString();
  }

  // Save all data to JSONBin
  async function saveAllData() {
    try {
      const dataToSave = {
        users,
        posts,
        dms
      };
      const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': WRITE_KEY,
          'X-Bin-Versioning': 'false'
        },
        body: JSON.stringify(dataToSave)
      });
      if (!res.ok) throw new Error('Failed saving data');
    } catch (e) {
      console.error('Save error:', e);
    }
  }

  // Load all data from JSONBin
  async function loadAllData() {
    try {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
        headers: {
          'X-Master-Key': READ_KEY
        }
      });
      if (!res.ok) throw new Error('Failed loading data');
      const json = await res.json();
      const data = json.record;
      users = data.users || {};
      posts = data.posts || [];
      dms = data.dms || {};
    } catch (e) {
      console.error('Load error:', e);
      users = {};
      posts = [];
      dms = {};
    }
  }

  // Save current user to localStorage
  function saveCurrentUser() {
    if (currentUser) {
      localStorage.setItem('taptextCurrentUser', currentUser.username);
    } else {
      localStorage.removeItem('taptextCurrentUser');
    }
  }

  // Load current user from localStorage
  function loadCurrentUser() {
    const username = localStorage.getItem('taptextCurrentUser');
    if (username && users[username] && !users[username].banned) {
      currentUser = users[username];
      return true;
    }
    currentUser = null;
    return false;
  }

  // Format username with verified tick if admin/owner
  function formatUsername(name) {
    if (!users[name]) return name;
    if (users[name].role === 'owner' || users[name].role === 'admin') {
      return `${name} ‚úîÔ∏è`;
    }
    return name;
  }

  // Check if user can view post based on age restriction
  function canViewPost(user, post) {
    if (!post.ageRestriction || post.ageRestriction === 'all') return true;
    if (!user) return false;
    const userAge = getAgeFromBirthdate(user.birthdate);
    if (post.ageRestriction === '10-12') return userAge >= 10 && userAge <= 12;
    if (post.ageRestriction === '13-17') return userAge >= 13 && userAge <= 17;
    if (post.ageRestriction === '18+') return userAge >= 18;
    return true;
  }

  // Get age number from birthdate string
  function getAgeFromBirthdate(birthdate) {
    if (!birthdate) return 0;
    const bd = new Date(birthdate);
    if (isNaN(bd.getTime())) return 0;
    const now = new Date();
    let age = now.getFullYear() - bd.getFullYear();
    if (now.getMonth() < bd.getMonth() || (now.getMonth() === bd.getMonth() && now.getDate() < bd.getDate())) {
      age--;
    }
    return age;
  }

  // Show user info on sidebar
  function renderUserInfo() {
    if (!currentUser) {
      currentUsernameSpan.textContent = 'Not logged in';
      currentRoleSpan.textContent = 'Role: Guest';
      verifiedTickSpan.style.display = 'none';
      parentOfSpan.style.display = 'none';
      childrenListSpan.textContent = '';
      currentAgeSpan.textContent = '';
      btnLogout.style.display = 'none';
      followSection.style.display = 'none';
      newPostSection.style.display = 'none';
      dmCenter.style.display = 'none';
      authSection.style.display = '';
      return;
    }
    currentUsernameSpan.textContent = currentUser.username;
    currentRoleSpan.textContent = `Role: ${capitalize(currentUser.role)}`;
    verifiedTickSpan.style.display = (currentUser.role === 'owner' || currentUser.role === 'admin') ? 'inline' : 'none';
    currentAgeSpan.textContent = `Age: ${getAgeFromBirthdate(currentUser.birthdate)}`;
    if (currentUser.isParent && currentUser.children && currentUser.children.length > 0) {
      parentOfSpan.style.display = 'block';
      childrenListSpan.textContent = currentUser.children.join(', ');
    } else {
      parentOfSpan.style.display = 'none';
      childrenListSpan.textContent = '';
    }
    btnLogout.style.display = 'block';
    followSection.style.display = 'block';
    newPostSection.style.display = 'block';
    dmCenter.style.display = 'flex';
    authSection.style.display = 'none';
    renderFollowingList();
    renderPosts();
    renderDmUsers();
  }

  // Capitalize first letter
  function capitalize(str) {
    if (!str) return '';
    return str[0].toUpperCase() + str.slice(1);
  }

  // Render following list
  function renderFollowingList() {
    followingList.innerHTML = '';
    if (!currentUser || !currentUser.following) return;
    currentUser.following.forEach(followedUser => {
      const div = document.createElement('div');
      div.textContent = followedUser;
      const unfollowBtn = document.createElement('button');
      unfollowBtn.textContent = 'Unfollow';
      unfollowBtn.title = `Unfollow ${followedUser}`;
      unfollowBtn.addEventListener('click', () => {
        unfollowUser(followedUser);
      });
      div.appendChild(unfollowBtn);
      followingList.appendChild(div);
    });
  }

  // Follow a user
  function followUser(usernameToFollow) {
    if (!currentUser) return;
    if (!users[usernameToFollow]) {
      alert('User does not exist.');
      return;
    }
    if (usernameToFollow === currentUser.username) {
      alert("You can't follow yourself.");
      return;
    }
    if (!currentUser.following) currentUser.following = [];
    if (!currentUser.following.includes(usernameToFollow)) {
      currentUser.following.push(usernameToFollow);
      if (!users[usernameToFollow].followers) users[usernameToFollow].followers = [];
      if (!users[usernameToFollow].followers.includes(currentUser.username)) {
        users[usernameToFollow].followers.push(currentUser.username);
      }
      saveAllData();
      renderFollowingList();
      alert(`You are now following ${usernameToFollow}`);
    } else {
      alert(`You already follow ${usernameToFollow}`);
    }
  }

  // Unfollow a user
  function unfollowUser(usernameToUnfollow) {
    if (!currentUser) return;
    if (!currentUser.following) return;
    currentUser.following = currentUser.following.filter(u => u !== usernameToUnfollow);
    if (users[usernameToUnfollow] && users[usernameToUnfollow].followers) {
      users[usernameToUnfollow].followers = users[usernameToUnfollow].followers.filter(u => u !== currentUser.username);
    }
    saveAllData();
    renderFollowingList();
  }

  // Render posts feed
  function renderPosts() {
    postsContainer.innerHTML = '';
    if (!currentUser) return;
    const userAge = getAgeFromBirthdate(currentUser.birthdate);
    const canView = p => canViewPost(currentUser, p) && !users[p.author]?.banned;
    const visiblePosts = posts.filter(canView).sort((a,b) => b.timestamp - a.timestamp);
    visiblePosts.forEach(post => {
      const div = document.createElement('div');
      div.className = 'post';
      const postDate = new Date(post.timestamp);
      div.innerHTML = `
        <div class="post-header" aria-label="Post header">
          <span class="post-username">${post.author} ${((users[post.author]?.role==='owner' || users[post.author]?.role==='admin') ? '‚úîÔ∏è' : '')}</span>
          <span class="post-role">(${capitalize(users[post.author]?.role||'user')})</span>
          <span class="post-time">${timeAgo(postDate)}</span>
        </div>
        <div class="post-content">${escapeHtml(post.content)}</div>
      `;
      if (post.mediaUrl) {
        if (isVideoUrl(post.mediaUrl)) {
          const video = document.createElement('video');
          video.controls = true;
          video.src = post.mediaUrl;
          div.appendChild(video);
        } else if (isImageUrl(post.mediaUrl)) {
          const img = document.createElement('img');
          img.src = post.mediaUrl;
          img.alt = 'Post media';
          div.appendChild(img);
        }
      }
      if (currentUser.role === 'admin' || currentUser.role === 'owner') {
        const adminControls = document.createElement('div');
        adminControls.className = 'admin-controls';
        const btnBan = document.createElement('button');
        btnBan.textContent = users[post.author]?.banned ? 'Unban' : 'Ban';
        btnBan.title = `${btnBan.textContent} user ${post.author}`;
        btnBan.addEventListener('click', () => toggleBanUser(post.author));
        adminControls.appendChild(btnBan);

        const btnWarn = document.createElement('button');
        btnWarn.textContent = 'Warn';
        btnWarn.title = `Warn user ${post.author}`;
        btnWarn.addEventListener('click', () => warnUser(post.author));
        adminControls.appendChild(btnWarn);

        const btnDeletePost = document.createElement('button');
        btnDeletePost.textContent = 'Delete Post';
        btnDeletePost.title = `Delete this post`;
        btnDeletePost.addEventListener('click', () => deletePost(post.id));
        adminControls.appendChild(btnDeletePost);

        div.appendChild(adminControls);
      }
      postsContainer.appendChild(div);
    });
  }

  // Escape HTML to avoid injection
  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/[&<>"'`=\/]/g, function(s) {
      return ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
        '`': '&#x60;',
        '=': '&#x3D;',
        '/': '&#x2F;'
      })[s];
    });
  }

  // Check if URL points to image
  function isImageUrl(url) {
    return /\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i.test(url);
  }
  // Check if URL points to video
  function isVideoUrl(url) {
    return /\.(mp4|webm|ogg)$/i.test(url);
  }

  // Toggle ban user
  function toggleBanUser(username) {
    if (!users[username]) return;
    if (username === currentUser.username) {
      alert("You can't ban yourself.");
      return;
    }
    users[username].banned = !users[username].banned;
    saveAllData();
    alert(`${username} is now ${users[username].banned ? 'banned' : 'unbanned'}`);
    if (users[username].banned && username === currentUser.username) {
      alert('You have been banned and logged out.');
      logout();
      return;
    }
    renderPosts();
  }

  // Warn user (admin only)
  function warnUser(username) {
    if (!users[username]) return;
    users[username].warnings = users[username].warnings || [];
    users[username].warnings.push({
      date: Date.now(),
      message: 'Warning issued by admin.'
    });
    saveAllData();
    alert(`User ${username} has been warned.`);
  }

  // Delete post by id (admin only)
  function deletePost(postId) {
    posts = posts.filter(p => p.id !== postId);
    saveAllData();
    renderPosts();
  }

  // Create new post
  function createNewPost() {
    postErrorDiv.textContent = '';
    const content = newPostContent.value.trim();
    const mediaUrl = newPostMediaUrl.value.trim();
    const ageRestrictionValue = postAgeRestriction.value;
    if (!content && !mediaUrl) {
      postErrorDiv.textContent = 'Post content or media URL is required.';
      return;
    }
    if (mediaUrl && !isImageUrl(mediaUrl) && !isVideoUrl(mediaUrl)) {
      postErrorDiv.textContent = 'Media URL must be a valid image or video link.';
      return;
    }
    const newPost = {
      id: Date.now() + Math.random().toString(36).slice(2),
      author: currentUser.username,
      content,
      mediaUrl: mediaUrl || null,
      timestamp: Date.now(),
      ageRestriction: ageRestrictionValue
    };
    posts.push(newPost);
    saveAllData();
    newPostContent.value = '';
    newPostMediaUrl.value = '';
    postAgeRestriction.value = 'all';
    btnPost.disabled = true;
    renderPosts();
  }

  // Validate post input to enable/disable post button
  function validatePostInput() {
    const content = newPostContent.value.trim();
    const mediaUrl = newPostMediaUrl.value.trim();
    btnPost.disabled = (!content && !mediaUrl);
    postErrorDiv.textContent = '';
  }

  // Search users for follow by partial username
  function searchUsers(query) {
    if (!query) return [];
    const lowerQ = query.toLowerCase();
    return Object.keys(users)
      .filter(u => u.toLowerCase().includes(lowerQ) && u !== currentUser.username)
      .slice(0, 10);
  }

  // Render DM users list
  function renderDmUsers() {
    dmUsersList.innerHTML = '';
    if (!currentUser || !currentUser.following) return;
    const dmUsers = currentUser.following.filter(u => users[u] && !users[u].banned);
    if (dmUsers.length === 0) {
      dmUsersList.innerHTML = '<div>No DM contacts</div>';
      clearDmChat();
      return;
    }
    dmUsers.forEach(u => {
      const div = document.createElement('div');
      div.textContent = u + ((users[u].role==='owner' || users[u].role==='admin') ? ' ‚úîÔ∏è' : '');
      div.setAttribute('role', 'listitem');
      div.tabIndex = 0;
      div.addEventListener('click', () => {
        selectDmUser(u);
      });
      dmUsersList.appendChild(div);
    });
  }

  // Selected DM user for chat
  let selectedDmUser = null;

  // Select DM user
  function selectDmUser(username) {
    selectedDmUser = username;
    [...dmUsersList.children].forEach(div => {
      div.classList.toggle('active', div.textContent.startsWith(username));
    });
    renderDmMessages();
  }

  // Clear DM chat
  function clearDmChat() {
    dmMessages.innerHTML = '';
    dmInput.value = '';
    dmSendBtn.disabled = true;
  }

  // Get DM conversation key (sorted)
  function getDmKey(u1, u2) {
    return [u1,u2].sort().join('_');
  }

  // Render DM messages for selected user
  function renderDmMessages() {
    dmMessages.innerHTML = '';
    if (!selectedDmUser) return;
    const key = getDmKey(currentUser.username, selectedDmUser);
    const conversation = dms[key] || [];
    conversation.forEach(msg => {
      const div = document.createElement('div');
      div.className = 'dm-message';
      div.classList.add(msg.sender === currentUser.username ? 'sent' : 'received');
      div.textContent = msg.message;
      dmMessages.appendChild(div);
    });
    dmMessages.scrollTop = dmMessages.scrollHeight;
  }

  // Send DM message
  function sendDmMessage() {
    if (!selectedDmUser) return;
    const msg = dmInput.value.trim();
    if (!msg) return;
    const key = getDmKey(currentUser.username, selectedDmUser);
    if (!dms[key]) dms[key] = [];
    dms[key].push({
      sender: currentUser.username,
      message: msg,
      timestamp: Date.now()
    });
    dmInput.value = '';
    dmSendBtn.disabled = true;
    saveAllData();
    renderDmMessages();
  }

  // Event Listeners

  // Theme toggle
  themeToggleBtn.addEventListener('click', () => {
    document.body.classList.toggle('dark-theme');
    themeToggleBtn.textContent = document.body.classList.contains('dark-theme') ? '‚òÄÔ∏è' : 'üåô';
  });

  // Logout
  btnLogout.addEventListener('click', () => {
    logout();
  });

  // Follow button
  btnFollow.addEventListener('click', () => {
    const usernameToFollow = searchUserInput.value.trim();
    if (!usernameToFollow) return;
    followUser(usernameToFollow);
    searchUserInput.value = '';
  });

  // Search input autocomplete and suggestions
  searchUserInput.addEventListener('input', () => {
    const query = searchUserInput.value.trim();
    if (!query) return;
    const results = searchUsers(query);
    // For simplicity: just replace input value with first match (you can enhance this with dropdown)
    if (results.length > 0) {
      // no dropdown - manual typing
    }
  });

  // Auth form submission
  authForm.addEventListener('submit', async e => {
    e.preventDefault();
    authErrorDiv.textContent = '';
    const username = usernameInput.value.trim();
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    const birthdate = birthdateInput.value;
    const isParent = isParentCheckbox.checked;

    if (username.length < 3 || username.length > 20) {
      authErrorDiv.textContent = 'Username must be between 3 and 20 characters.';
      return;
    }
    if (!/^[a-zA-Z0-9_]+$/.test(username)) {
      authErrorDiv.textContent = 'Username can only contain letters, numbers, and underscores.';
      return;
    }
    if (!password || password.length < 6) {
      authErrorDiv.textContent = 'Password must be at least 6 characters.';
      return;
    }
    if (password !== confirmPassword) {
      authErrorDiv.textContent = 'Passwords do not match.';
      return;
    }
    if (!birthdate) {
      authErrorDiv.textContent = 'Birthdate is required.';
      return;
    }
    if (!isOldEnough(birthdate)) {
      authErrorDiv.textContent = `You must be at least ${MIN_AGE} years old to register.`;
      return;
    }

    // Check if user exists
    if (users[username]) {
      // Login flow
      const hashed = hashPassword(password);
      if (users[username].passwordHash !== hashed) {
        authErrorDiv.textContent = 'Incorrect password.';
        return;
      }
      if (users[username].banned) {
        authErrorDiv.textContent = 'Your account is banned.';
        return;
      }
      currentUser = users[username];
      saveCurrentUser();
      renderUserInfo();
    } else {
      // Register flow
      users[username] = {
        username,
        passwordHash: hashPassword(password),
        birthdate,
        role: 'user',
        isParent,
        children: [],
        followers: [],
        following: [],
        warnings: [],
        banned: false
      };
      if (username === 'AHDX') {
        users[username].role = 'owner'; // Owner role for AHDX
      }
      saveAllData();
      currentUser = users[username];
      saveCurrentUser();
      renderUserInfo();
    }
  });

  // Post content input validation
  newPostContent.addEventListener('input', validatePostInput);
  newPostMediaUrl.addEventListener('input', validatePostInput);

  // Post button click
  btnPost.addEventListener('click', () => {
    createNewPost();
  });

  // DM input validation
  dmInput.addEventListener('input', () => {
    dmSendBtn.disabled = dmInput.value.trim() === '';
  });

  // DM send button
  dmSendBtn.addEventListener('click', () => {
    sendDmMessage();
  });

  // Initialization
  async function init() {
    // Set max birthdate to today - MIN_AGE years
    const today = new Date();
    const maxDate = new Date(today.getFullYear() - MIN_AGE, today.getMonth(), today.getDate());
    birthdateInput.max = maxDate.toISOString().split('T')[0];

    await loadAllData();
    const loggedIn = loadCurrentUser();
    if (loggedIn) {
      renderUserInfo();
    }
  }

  // Logout function
  function logout() {
    currentUser = null;
    saveCurrentUser();
    renderUserInfo();
  }

  init();

})();
</script>

</body>
</html>
