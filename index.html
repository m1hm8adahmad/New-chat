<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TapText - Social Platform</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter&display=swap');

    :root {
      --color-bg-light: #f0f2f5;
      --color-text-light: #1a1a1a;
      --color-primary: #1877f2;
      --color-primary-dark: #004080;
      --color-bg-dark: #18191a;
      --color-text-dark: #e4e6eb;
      --color-border-light: #ddd;
      --color-border-dark: #333;
      --color-error: #b22222;
      --color-warning: #ffae42;
    }

    body {
      margin: 0; padding: 0; font-family: 'Inter', sans-serif;
      background: var(--color-bg-light);
      color: var(--color-text-light);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    body.dark {
      background: var(--color-bg-dark);
      color: var(--color-text-dark);
    }

    header {
      background-color: var(--color-primary);
      color: white;
      padding: 1rem 2rem;
      font-size: 1.8rem;
      font-weight: 700;
      user-select: none;
      box-shadow: 0 4px 10px rgb(24 119 242 / 0.6);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header .theme-toggle {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-weight: 700;
      font-size: 1rem;
      padding: 0.3rem 0.8rem;
      border-radius: 6px;
      transition: background-color 0.3s ease;
    }
    header .theme-toggle:hover {
      background-color: rgba(255 255 255 / 0.25);
    }

    main {
      flex-grow: 1;
      max-width: 900px;
      width: 100%;
      margin: 1.5rem auto 3rem;
      padding: 1.5rem 2rem;
      background: white;
      border-radius: 14px;
      box-shadow: 0 8px 30px rgb(0 0 0 / 0.12);
    }
    body.dark main {
      background: #242526;
      box-shadow: 0 8px 30px rgb(0 0 0 / 0.7);
    }

    /* Login/Register Sections */
    section.auth-section {
      max-width: 400px;
      margin: 0 auto;
    }
    section.auth-section h2 {
      margin-bottom: 1rem;
      color: var(--color-primary-dark);
    }
    label {
      display: block;
      margin-top: 0.8rem;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 0.5rem 0.8rem;
      margin-top: 0.3rem;
      border: 1.5px solid var(--color-border-light);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
      background: white;
      color: var(--color-text-light);
    }
    body.dark input, body.dark select {
      background: #3a3b3c;
      color: var(--color-text-dark);
      border-color: var(--color-border-dark);
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--color-primary);
      background: #e6f0ff;
    }
    body.dark input:focus, body.dark select:focus {
      background: #4a4b4d;
    }

    button {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      width: 100%;
      font-size: 1.1rem;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      background-color: var(--color-primary);
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    button:hover:not(:disabled) {
      background-color: var(--color-primary-dark);
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }

    #errorMsg {
      margin-top: 0.5rem;
      color: var(--color-error);
      font-weight: 700;
      min-height: 1.2rem;
      user-select: none;
    }
    #successMsg {
      margin-top: 0.5rem;
      color: green;
      font-weight: 700;
      min-height: 1.2rem;
      user-select: none;
    }

    /* Navigation Tabs for Auth */
    #authTabs {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    #authTabs button {
      width: auto;
      padding: 0.5rem 1rem;
      border-radius: 30px;
      background: var(--color-bg-light);
      color: var(--color-primary);
      border: 2px solid var(--color-primary);
      font-weight: 700;
    }
    #authTabs button.active {
      background: var(--color-primary);
      color: white;
    }
    body.dark #authTabs button {
      background: #3a3b3c;
      color: var(--color-text-dark);
      border-color: var(--color-border-dark);
    }
    body.dark #authTabs button.active {
      background: var(--color-primary);
      color: white;
    }

    /* Logged in user info */
    #userInfo {
      text-align: center;
      margin-bottom: 1rem;
    }
    #userInfo strong {
      font-size: 1.2rem;
    }
    #logoutBtn {
      background-color: var(--color-primary);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
      margin-top: 0.8rem;
    }
    #logoutBtn:hover {
      background-color: var(--color-primary-dark);
    }

    /* Post Section */
    #postSection {
      margin-top: 2rem;
    }
    #postSection h3 {
      margin-bottom: 0.8rem;
      color: var(--color-primary-dark);
    }
    #postText, #postImageUrl {
      width: 100%;
      padding: 0.6rem 0.9rem;
      border-radius: 8px;
      border: 1.5px solid var(--color-border-light);
      font-size: 1rem;
      margin-bottom: 0.6rem;
      resize: vertical;
    }
    #postAgeGroup {
      width: 100%;
      padding: 0.5rem 0.8rem;
      border-radius: 8px;
      font-size: 1rem;
      border: 1.5px solid var(--color-border-light);
      margin-bottom: 0.8rem;
      background: white;
      color: var(--color-text-light);
    }
    body.dark #postText, body.dark #postImageUrl, body.dark #postAgeGroup {
      background: #3a3b3c;
      color: var(--color-text-dark);
      border-color: var(--color-border-dark);
    }
    #postBtn {
      background-color: var(--color-primary);
      border: none;
      color: white;
      font-weight: 700;
      padding: 0.7rem;
      width: 100%;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #postBtn:hover {
      background-color: var(--color-primary-dark);
    }

    /* Posts Feed */
    #postsFeed {
      margin-top: 2rem;
      max-height: 400px;
      overflow-y: auto;
      border: 1.5px solid var(--color-border-light);
      border-radius: 12px;
      padding: 1rem;
      background: var(--color-bg-light);
    }
    body.dark #postsFeed {
      background: #242526;
      border-color: var(--color-border-dark);
    }
    .post {
      margin-bottom: 1.3rem;
      border-bottom: 1px solid var(--color-border-light);
      padding-bottom: 0.8rem;
    }
    body.dark .post {
      border-color: var(--color-border-dark);
    }
    .post strong.username {
      color: var(--color-primary-dark);
      font-weight: 700;
    }
    .post .timestamp {
      color: #777;
      font-size: 0.85rem;
      float: right;
      user-select: none;
    }
    .post .postText {
      margin: 0.5rem 0;
      white-space: pre-wrap;
    }
    .post img, .post video {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 0.6rem;
      display: block;
    }

    /* DM Section */
    #dmSection {
      margin-top: 2rem;
      display: flex;
      height: 300px;
      gap: 1rem;
    }
    #dmUserList {
      flex: 0 0 140px;
      border: 1.5px solid var(--color-border-light);
      border-radius: 12px;
      overflow-y: auto;
      background: var(--color-bg-light);
    }
    body.dark #dmUserList {
      background: #242526;
      border-color: var(--color-border-dark);
    }
    .dmUser {
      padding: 0.5rem 1rem;
      cursor: pointer;
      user-select: none;
      border-bottom: 1px solid var(--color-border-light);
      transition: background-color 0.3s ease;
    }
    body.dark .dmUser {
      border-color: var(--color-border-dark);
    }
    .dmUser.active, .dmUser:hover {
      background-color: var(--color-primary);
      color: white;
    }
    #dmMessages {
      flex-grow: 1;
      border: 1.5px solid var(--color-border-light);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      padding: 0.7rem 1rem;
      background: var(--color-bg-light);
    }
    body.dark #dmMessages {
      background: #242526;
      border-color: var(--color-border-dark);
    }
    #dmMessages .message {
      max-width: 70%;
      margin-bottom: 0.6rem;
      padding: 0.5rem 0.8rem;
      border-radius: 12px;
      user-select: none;
      word-break: break-word;
      white-space: pre-wrap;
    }
    #dmMessages .message.sent {
      background-color: var(--color-primary);
      color: white;
      margin-left: auto;
    }
    #dmMessages .message.received {
      background-color: var(--color-border-light);
      color: var(--color-text-light);
    }
    body.dark #dmMessages .message.received {
      background-color: #3a3b3c;
      color: var(--color-text-dark);
    }
    #dmInputSection {
      margin-top: 0.5rem;
      display: flex;
      gap: 0.5rem;
    }
    #dmInput {
      flex-grow: 1;
      padding: 0.5rem 0.8rem;
      border-radius: 12px;
      border: 1.5px solid var(--color-border-light);
      font-size: 1rem;
      background: white;
      color: var(--color-text-light);
    }
    body.dark #dmInput {
      background: #3a3b3c;
      color: var(--color-text-dark);
      border-color: var(--color-border-dark);
    }
    #dmSendBtn {
      background-color: var(--color-primary);
      border: none;
      color: white;
      border-radius: 12px;
      padding: 0.5rem 1rem;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #dmSendBtn:hover {
      background-color: var(--color-primary-dark);
    }

    /* User Search */
    #searchUserInput {
      width: 100%;
      padding: 0.5rem 0.8rem;
      margin-bottom: 1rem;
      border-radius: 8px;
      border: 1.5px solid var(--color-border-light);
      font-size: 1rem;
      background: white;
      color: var(--color-text-light);
    }
    body.dark #searchUserInput {
      background: #3a3b3c;
      color: var(--color-text-dark);
      border-color: var(--color-border-dark);
    }
    #searchResults {
      max-height: 150px;
      overflow-y: auto;
      border: 1.5px solid var(--color-border-light);
      border-radius: 12px;
      padding: 0.5rem 1rem;
      background: var(--color-bg-light);
      margin-bottom: 1rem;
    }
    body.dark #searchResults {
      background: #242526;
      border-color: var(--color-border-dark);
    }
    .searchUserItem {
      padding: 0.3rem 0;
      cursor: pointer;
      user-select: none;
      color: var(--color-primary-dark);
      font-weight: 700;
      border-bottom: 1px solid var(--color-border-light);
    }
    body.dark .searchUserItem {
      border-color: var(--color-border-dark);
    }
    .searchUserItem:hover {
      text-decoration: underline;
    }

    /* Follow button */
    .followBtn {
      margin-left: 0.6rem;
      padding: 0.2rem 0.6rem;
      background: var(--color-primary);
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      font-size: 0.85rem;
      transition: background-color 0.3s ease;
    }
    .followBtn:hover {
      background-color: var(--color-primary-dark);
    }
    .followBtn:disabled {
      background-color: #999;
      cursor: not-allowed;
    }

    /* Responsive */
    @media (max-width: 600px) {
      main {
        margin: 1rem 0.8rem 3rem;
        padding: 1rem 1.2rem;
      }
      #dmSection {
        flex-direction: column;
        height: auto;
      }
      #dmUserList {
        flex: none;
        height: 120px;
        overflow-x: auto;
        display: flex;
        gap: 0.3rem;
      }
      .dmUser {
        flex: none;
        border-bottom: none;
        border-right: 1.5px solid var(--color-border-light);
        padding: 0.5rem 1rem;
        white-space: nowrap;
      }
      body.dark .dmUser {
        border-color: var(--color-border-dark);
      }
      #dmMessages {
        height: 220px;
      }
    }

  </style>
</head>
<body>
<header>
  <div>TapText</div>
  <button class="theme-toggle" id="themeToggleBtn" aria-label="Toggle Light/Dark Theme">Dark Mode</button>
</header>

<main>
  <!-- AUTH SECTION -->
  <section id="authSection" class="auth-section" aria-live="polite">
    <nav id="authTabs" role="tablist" aria-label="Authentication tabs">
      <button id="tabLogin" role="tab" aria-selected="true" tabindex="0">Login</button>
      <button id="tabRegister" role="tab" aria-selected="false" tabindex="-1">Register</button>
      <button id="tabParentRegister" role="tab" aria-selected="false" tabindex="-1">Parent Account</button>
    </nav>

    <form id="loginForm" aria-label="Login form">
      <h2>Login</h2>
      <label for="loginUsername">Username</label>
      <input type="text" id="loginUsername" name="loginUsername" autocomplete="username" required />

      <label for="loginPassword">Password</label>
      <input type="password" id="loginPassword" name="loginPassword" autocomplete="current-password" required />

      <button type="submit">Login</button>
      <div id="loginError" role="alert" aria-live="assertive"></div>
    </form>

    <form id="registerForm" style="display:none;" aria-label="User registration form">
      <h2>Register</h2>
      <label for="regUsername">Username</label>
      <input type="text" id="regUsername" name="regUsername" autocomplete="username" required />

      <label for="regAge">Age (must be 10 or older)</label>
      <input type="number" id="regAge" name="regAge" min="10" max="120" required />

      <label for="regPassword">Password</label>
      <input type="password" id="regPassword" name="regPassword" autocomplete="new-password" required />

      <label for="regPasswordConfirm">Confirm Password</label>
      <input type="password" id="regPasswordConfirm" name="regPasswordConfirm" autocomplete="new-password" required />

      <button type="submit">Register</button>
      <div id="registerError" role="alert" aria-live="assertive"></div>
      <div id="registerSuccess" role="status" aria-live="polite"></div>
    </form>

    <form id="parentRegisterForm" style="display:none;" aria-label="Parent account registration form">
      <h2>Parent Account Registration</h2>
      <label for="parentUsername">Parent Username</label>
      <input type="text" id="parentUsername" name="parentUsername" autocomplete="username" required />

      <label for="parentPassword">Password</label>
      <input type="password" id="parentPassword" name="parentPassword" autocomplete="new-password" required />

      <label for="parentPasswordConfirm">Confirm Password</label>
      <input type="password" id="parentPasswordConfirm" name="parentPasswordConfirm" autocomplete="new-password" required />

      <button type="submit">Create Parent Account</button>
      <div id="parentRegisterError" role="alert" aria-live="assertive"></div>
      <div id="parentRegisterSuccess" role="status" aria-live="polite"></div>
    </form>
  </section>

  <!-- LOGGED-IN USER SECTION -->
  <section id="userSection" style="display:none;">
    <div id="userInfo">
      Logged in as: <strong id="currentUsername"></strong>
      <br />
      Age: <span id="currentUserAge"></span>
      <br />
      <button id="logoutBtn">Logout</button>
    </div>

    <input type="text" id="searchUserInput" placeholder="Search users to follow or DM" aria-label="Search users" autocomplete="off" />
    <div id="searchResults" role="list" aria-live="polite" aria-relevant="additions"></div>

    <!-- Posts -->
    <section id="postSection" aria-label="Create new post">
      <h3>Create a Post</h3>
      <textarea id="postText" rows="3" placeholder="Write something..." maxlength="500" aria-describedby="postHelp" required></textarea>
      <input type="url" id="postMediaUrl" placeholder="Optional Image or Video URL (MP4, JPG, PNG)" aria-label="Post media URL" />
      <label for="postAgeGroup">Restrict post visibility by age group:</label>
      <select id="postAgeGroup" aria-label="Select age group visibility for post">
        <option value="all" selected>All Ages</option>
        <option value="10-12">10-12</option>
        <option value="13-17">13-17</option>
        <option value="18-25">18-25</option>
        <option value="26-120">26+</option>
      </select>
      <button id="postBtn">Post</button>
      <div id="postError" role="alert" aria-live="assertive"></div>
    </section>

    <!-- Posts feed -->
    <section id="postsFeed" aria-label="Posts feed"></section>

    <!-- DM Center -->
    <section id="dmSection" aria-label="Direct Messaging" hidden>
      <div id="dmUserList" role="list" aria-label="Direct Message Users"></div>
      <div id="dmMessages" role="log" aria-live="polite" aria-relevant="additions"></div>
      <div id="dmInputSection">
        <input id="dmInput" type="text" placeholder="Type your message..." aria-label="Message input" autocomplete="off" />
        <button id="dmSendBtn">Send</button>
      </div>
    </section>
  </section>
</main>

<script>
  // Backend JSONBin info
  const BIN_ID = "6863fa078561e97a502fb26c";
  const WRITE_KEY = "$2a$10$4EX1ZT6TPAE1x4NBUFgmt.Qvwek6Ognuqf1kNZ.Y8IjLfKf2i0GUG";
  const READ_KEY = WRITE_KEY;

  // State & cache
  let currentUser = null;
  let users = [];
  let posts = [];
  let dms = {};
  let theme = localStorage.getItem('taptext-theme') || 'light';

  // DOM Elements
  const body = document.body;
  const themeToggleBtn = document.getElementById('themeToggleBtn');

  const authSection = document.getElementById('authSection');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const parentRegisterForm = document.getElementById('parentRegisterForm');
  const tabLogin = document.getElementById('tabLogin');
  const tabRegister = document.getElementById('tabRegister');
  const tabParentRegister = document.getElementById('tabParentRegister');

  const loginError = document.getElementById('loginError');
  const registerError = document.getElementById('registerError');
  const registerSuccess = document.getElementById('registerSuccess');
  const parentRegisterError = document.getElementById('parentRegisterError');
  const parentRegisterSuccess = document.getElementById('parentRegisterSuccess');

  const userSection = document.getElementById('userSection');
  const currentUsernameElem = document.getElementById('currentUsername');
  const currentUserAgeElem = document.getElementById('currentUserAge');
  const logoutBtn = document.getElementById('logoutBtn');

  const searchUserInput = document.getElementById('searchUserInput');
  const searchResults = document.getElementById('searchResults');

  const postText = document.getElementById('postText');
  const postMediaUrl = document.getElementById('postMediaUrl');
  const postAgeGroup = document.getElementById('postAgeGroup');
  const postBtn = document.getElementById('postBtn');
  const postError = document.getElementById('postError');
  const postsFeed = document.getElementById('postsFeed');

  const dmSection = document.getElementById('dmSection');
  const dmUserList = document.getElementById('dmUserList');
  const dmMessages = document.getElementById('dmMessages');
  const dmInput = document.getElementById('dmInput');
  const dmSendBtn = document.getElementById('dmSendBtn');

  // Utils
  function sleep(ms) {
    return new Promise(r => setTimeout(r, ms));
  }

  function hashPassword(pw) {
    // Simple hashing stub: use btoa for demo only, replace with real hash in prod
    return btoa(pw);
  }

  // Load JSONBin data
  async function fetchData() {
    try {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
        headers: { 'X-Master-Key': READ_KEY }
      });
      if (!res.ok) throw new Error('Failed to fetch backend data.');
      const json = await res.json();
      if(json.record){
        users = json.record.users || [];
        posts = json.record.posts || [];
        dms = json.record.dms || {};
      } else {
        users = [];
        posts = [];
        dms = {};
      }
    } catch (e) {
      console.error(e);
      users = [];
      posts = [];
      dms = {};
    }
  }

  async function saveData() {
    try {
      const dataToSave = { users, posts, dms };
      const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': WRITE_KEY,
          'X-Bin-Versioning': 'false'
        },
        body: JSON.stringify(dataToSave)
      });
      if (!res.ok) throw new Error('Failed to save backend data.');
      return true;
    } catch (e) {
      console.error(e);
      return false;
    }
  }

  // Authentication tab switching
  function switchAuthTab(tabName) {
    loginForm.style.display = 'none';
    registerForm.style.display = 'none';
    parentRegisterForm.style.display = 'none';

    tabLogin.setAttribute('aria-selected', 'false');
    tabRegister.setAttribute('aria-selected', 'false');
    tabParentRegister.setAttribute('aria-selected', 'false');

    tabLogin.tabIndex = -1;
    tabRegister.tabIndex = -1;
    tabParentRegister.tabIndex = -1;

    if (tabName === 'login') {
      loginForm.style.display = 'block';
      tabLogin.setAttribute('aria-selected', 'true');
      tabLogin.tabIndex = 0;
      loginError.textContent = '';
    } else if (tabName === 'register') {
      registerForm.style.display = 'block';
      tabRegister.setAttribute('aria-selected', 'true');
      tabRegister.tabIndex = 0;
      registerError.textContent = '';
      registerSuccess.textContent = '';
    } else if (tabName === 'parentRegister') {
      parentRegisterForm.style.display = 'block';
      tabParentRegister.setAttribute('aria-selected', 'true');
      tabParentRegister.tabIndex = 0;
      parentRegisterError.textContent = '';
      parentRegisterSuccess.textContent = '';
    }
  }

  tabLogin.addEventListener('click', () => switchAuthTab('login'));
  tabRegister.addEventListener('click', () => switchAuthTab('register'));
  tabParentRegister.addEventListener('click', () => switchAuthTab('parentRegister'));

  // Theme toggle
  function applyTheme(t) {
    if (t === 'dark') {
      body.classList.add('dark');
      themeToggleBtn.textContent = 'Light Mode';
    } else {
      body.classList.remove('dark');
      themeToggleBtn.textContent = 'Dark Mode';
    }
    localStorage.setItem('taptext-theme', t);
  }
  themeToggleBtn.addEventListener('click', () => {
    theme = (theme === 'dark') ? 'light' : 'dark';
    applyTheme(theme);
  });
  applyTheme(theme);

  // Login handler
  loginForm.addEventListener('submit', async e => {
    e.preventDefault();
    loginError.textContent = '';
    const username = loginForm.loginUsername.value.trim();
    const password = loginForm.loginPassword.value;

    if (!username || !password) {
      loginError.textContent = 'Please enter username and password.';
      return;
    }
    // Check banned first (admins not touched, but ban flag exists)
    const user = users.find(u => u.username.toLowerCase() === username.toLowerCase());
    if (!user) {
      loginError.textContent = 'Invalid username or password.';
      return;
    }
    if(user.banned){
      loginError.textContent = 'You are banned. Contact admin.';
      return;
    }
    // Check password match
    if (user.password !== hashPassword(password)) {
      loginError.textContent = 'Invalid username or password.';
      return;
    }

    currentUser = user;
    showUserSection();
  });

  // Register handler (normal user)
  registerForm.addEventListener('submit', async e => {
    e.preventDefault();
    registerError.textContent = '';
    registerSuccess.textContent = '';

    const username = registerForm.regUsername.value.trim();
    const age = parseInt(registerForm.regAge.value, 10);
    const pw1 = registerForm.regPassword.value;
    const pw2 = registerForm.regPasswordConfirm.value;

    if (!username || !age || !pw1 || !pw2) {
      registerError.textContent = 'Please fill all fields.';
      return;
    }
    if (age < 10) {
      registerError.textContent = 'You must be at least 10 years old to register.';
      return;
    }
    if (pw1 !== pw2) {
      registerError.textContent = 'Passwords do not match.';
      return;
    }
    if (users.find(u => u.username.toLowerCase() === username.toLowerCase())) {
      registerError.textContent = 'Username already exists.';
      return;
    }

    // Normal user role = 'user'
    const newUser = {
      username,
      age,
      password: hashPassword(pw1),
      role: 'user',
      banned: false,
      warnings: 0,
      following: [],
      followers: [],
      parentAccount: null, // no parent by default
      createdAt: Date.now()
    };
    users.push(newUser);
    await saveData();
    registerSuccess.textContent = 'Account created successfully. You can now log in.';
    registerForm.reset();
  });

  // Parent account registration
  parentRegisterForm.addEventListener('submit', async e => {
    e.preventDefault();
    parentRegisterError.textContent = '';
    parentRegisterSuccess.textContent = '';

    const username = parentRegisterForm.parentUsername.value.trim();
    const pw1 = parentRegisterForm.parentPassword.value;
    const pw2 = parentRegisterForm.parentPasswordConfirm.value;

    if (!username || !pw1 || !pw2) {
      parentRegisterError.textContent = 'Please fill all fields.';
      return;
    }
    if (pw1 !== pw2) {
      parentRegisterError.textContent = 'Passwords do not match.';
      return;
    }
    if (users.find(u => u.username.toLowerCase() === username.toLowerCase())) {
      parentRegisterError.textContent = 'Username already exists.';
      return;
    }

    const newParentUser = {
      username,
      age: 30, // default parent age (can be changed later)
      password: hashPassword(pw1),
      role: 'parent',
      banned: false,
      warnings: 0,
      following: [],
      followers: [],
      childrenAccounts: [], // track child accounts linked to this parent
      createdAt: Date.now()
    };
    users.push(newParentUser);
    await saveData();
    parentRegisterSuccess.textContent = 'Parent account created. You can now log in.';
    parentRegisterForm.reset();
  });

  // Show user section after login
  function showUserSection() {
    authSection.style.display = 'none';
    userSection.style.display = 'block';

    currentUsernameElem.textContent = currentUser.username + (currentUser.role === 'parent' ? ' (Parent)' : '');
    currentUserAgeElem.textContent = currentUser.age;

    loadPosts();
    loadFollowersAndSearch();
    loadDMs();
  }

  // Logout
  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    authSection.style.display = 'block';
    userSection.style.display = 'none';

    postText.value = '';
    postMediaUrl.value = '';
    postAgeGroup.value = 'all';

    dmUserList.innerHTML = '';
    dmMessages.innerHTML = '';
    searchUserInput.value = '';
    searchResults.innerHTML = '';
  });

  // Load posts filtered by user's age and following
  function loadPosts() {
    postsFeed.innerHTML = '';
    if (!currentUser) return;

    // Posts visible if:
    // - postAgeGroup = 'all' OR user.age in postAgeGroup range
    // - AND post by user or someone user follows (or all users' posts)
    // For simplicity, all posts shown but filtered by age visibility

    const visiblePosts = posts.filter(post => {
      if(!post) return false;
      if(!post.ageGroup || post.ageGroup === 'all') return true;
      const [minAge, maxAge] = post.ageGroup.split('-').map(n => parseInt(n));
      if (maxAge) return currentUser.age >= minAge && currentUser.age <= maxAge;
      return currentUser.age >= minAge;
    }).sort((a, b) => b.createdAt - a.createdAt);

    visiblePosts.forEach(post => {
      const postElem = document.createElement('article');
      postElem.className = 'post';
      const timeString = new Date(post.createdAt).toLocaleString();
      postElem.innerHTML = `
        <strong class="username">${post.author}</strong> <span class="timestamp">${timeString}</span>
        <p class="postText"></p>
      `;
      postElem.querySelector('.postText').textContent = post.text;

      if(post.mediaUrl){
        if(post.mediaUrl.match(/\.(mp4|webm|ogg)$/i)){
          const video = document.createElement('video');
          video.src = post.mediaUrl;
          video.controls = true;
          postElem.appendChild(video);
        } else if(post.mediaUrl.match(/\.(jpeg|jpg|gif|png)$/i)){
          const img = document.createElement('img');
          img.src = post.mediaUrl;
          postElem.appendChild(img);
        }
      }
      postsFeed.appendChild(postElem);
    });
  }

  // Post submission
  postBtn.addEventListener('click', async () => {
    postError.textContent = '';
    if(!currentUser) return;

    let text = postText.value.trim();
    let mediaUrl = postMediaUrl.value.trim();
    let ageGroup = postAgeGroup.value;

    if(!text && !mediaUrl){
      postError.textContent = 'Please write a post or provide a media URL.';
      return;
    }
    if(text.length > 500){
      postError.textContent = 'Post text cannot exceed 500 characters.';
      return;
    }
    if(mediaUrl && !mediaUrl.match(/^https?:\/\//)){
      postError.textContent = 'Media URL must start with http:// or https://';
      return;
    }

    // Save post
    const newPost = {
      id: crypto.randomUUID(),
      author: currentUser.username,
      text,
      mediaUrl: mediaUrl || null,
      ageGroup,
      createdAt: Date.now(),
    };
    posts.push(newPost);
    await saveData();

    postText.value = '';
    postMediaUrl.value = '';
    postAgeGroup.value = 'all';

    loadPosts();
  });

  // Search users to follow or DM
  searchUserInput.addEventListener('input', () => {
    const term = searchUserInput.value.trim().toLowerCase();
    searchResults.innerHTML = '';

    if(!term){
      return;
    }
    const matchedUsers = users.filter(u => u.username.toLowerCase().includes(term) && u.username.toLowerCase() !== currentUser.username.toLowerCase());
    if(matchedUsers.length === 0){
      searchResults.textContent = 'No users found.';
      return;
    }
    matchedUsers.forEach(u => {
      const div = document.createElement('div');
      div.className = 'searchUserItem';
      div.textContent = u.username + (u.role === 'parent' ? ' (Parent)' : '');
      div.tabIndex = 0;
      div.setAttribute('role', 'button');
      div.addEventListener('click', () => {
        toggleFollow(u.username);
      });
      searchResults.appendChild(div);
    });
  });

  // Follow/unfollow user
  async function toggleFollow(usernameToFollow) {
    if(!currentUser) return;
    if(currentUser.username === usernameToFollow) return;

    const targetUser = users.find(u => u.username === usernameToFollow);
    if(!targetUser) return;

    if(currentUser.following.includes(usernameToFollow)){
      // Unfollow
      currentUser.following = currentUser.following.filter(u => u !== usernameToFollow);
      targetUser.followers = targetUser.followers.filter(u => u !== currentUser.username);
    } else {
      // Follow
      currentUser.following.push(usernameToFollow);
      targetUser.followers.push(currentUser.username);
    }
    await saveData();
    loadFollowersAndSearch();
  }

  // Reload search results to update follow button state
  function loadFollowersAndSearch() {
    const term = searchUserInput.value.trim().toLowerCase();
    searchResults.innerHTML = '';
    if(!term) return;

    const matchedUsers = users.filter(u => u.username.toLowerCase().includes(term) && u.username.toLowerCase() !== currentUser.username.toLowerCase());
    matchedUsers.forEach(u => {
      const div = document.createElement('div');
      div.className = 'searchUserItem';
      div.textContent = u.username + (u.role === 'parent' ? ' (Parent)' : '');
      div.tabIndex = 0;
      div.setAttribute('role', 'button');
      const isFollowing = currentUser.following.includes(u.username);
      const followBtn = document.createElement('button');
      followBtn.className = 'followBtn';
      followBtn.textContent = isFollowing ? 'Unfollow' : 'Follow';
      followBtn.addEventListener('click', e => {
        e.stopPropagation();
        toggleFollow(u.username);
      });
      div.appendChild(followBtn);
      searchResults.appendChild(div);
    });
  }

  // DM Section
  let currentDMUser = null;

  function loadDMs() {
    dmUserList.innerHTML = '';
    if (!currentUser) return;

    const dmUsers = Object.keys(dms).filter(k => k.includes(currentUser.username));

    // Find unique usernames from DM keys except current user
    const uniqueUsernames = new Set();
    dmUsers.forEach(key => {
      const usersInKey = key.split(':');
      usersInKey.forEach(u => {
        if (u !== currentUser.username) uniqueUsernames.add(u);
      });
    });

    if(uniqueUsernames.size === 0){
      dmUserList.innerHTML = '<p style="padding:1rem; user-select:none;">No DMs yet</p>';
      dmSection.hidden = true;
      return;
    }
    dmSection.hidden = false;

    uniqueUsernames.forEach(username => {
      const div = document.createElement('div');
      div.className = 'dmUser';
      div.textContent = username;
      div.tabIndex = 0;
      div.addEventListener('click', () => openDM(username));
      dmUserList.appendChild(div);
    });

    if(!currentDMUser && uniqueUsernames.size > 0){
      openDM([...uniqueUsernames][0]);
    }
  }

  function openDM(username) {
    currentDMUser = username;
    [...dmUserList.children].forEach(div => {
      div.classList.toggle('active', div.textContent === username);
    });
    renderDMMessages();
  }

  function renderDMMessages() {
    dmMessages.innerHTML = '';
    if (!currentUser || !currentDMUser) return;

    const key1 = `${currentUser.username}:${currentDMUser}`;
    const key2 = `${currentDMUser}:${currentUser.username}`;
    const convo = dms[key1] || dms[key2] || [];

    convo.forEach(msg => {
      const div = document.createElement('div');
      div.className = 'message ' + (msg.sender === currentUser.username ? 'sent' : 'received');
      div.textContent = msg.text;
      dmMessages.appendChild(div);
    });
    dmMessages.scrollTop = dmMessages.scrollHeight;
  }

  dmSendBtn.addEventListener('click', sendDM);
  dmInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendDM();
    }
  });

  async function sendDM() {
    const msg = dmInput.value.trim();
    if (!msg || !currentUser || !currentDMUser) return;

    const key1 = `${currentUser.username}:${currentDMUser}`;
    const key2 = `${currentDMUser}:${currentUser.username}`;
    if (!dms[key1] && !dms[key2]) dms[key1] = [];
    const key = dms[key1] ? key1 : key2;

    dms[key].push({
      sender: currentUser.username,
      text: msg,
      timestamp: Date.now()
    });

    await saveData();
    dmInput.value = '';
    renderDMMessages();
  }

  // Load initial data & setup
  (async () => {
    await fetchData();

    // Check if user was logged in (simple session using localStorage)
    const savedUsername = localStorage.getItem('taptext-currentUser');
    if(savedUsername){
      const savedUser = users.find(u => u.username === savedUsername);
      if(savedUser && !savedUser.banned){
        currentUser = savedUser;
        showUserSection();
      } else {
        localStorage.removeItem('taptext-currentUser');
      }
    }

    // Switch auth tab default to login
    switchAuthTab('login');
  })();

  // Save current user session
  function saveSession(){
    if(currentUser){
      localStorage.setItem('taptext-currentUser', currentUser.username);
    } else {
      localStorage.removeItem('taptext-currentUser');
    }
  }

  // Wrap showUserSection to also save session
  const originalShowUserSection = showUserSection;
  showUserSection = function(){
    originalShowUserSection();
    saveSession();
  };

  // Wrap logout to clear session
  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    saveSession();
  });

</script>

</body>
</html>
